var lightImages = [
  "data:image/svg+xml;base64,CiAgPHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPScxMDAlJyBoZWlnaHQ9JzEwMCUnPgogIAk8cmVjdCB3aWR0aD0nMTAwJScgaGVpZ2h0PScxMDAlJyBmaWxsPScjMDg0NDZiJy8+CgkJPHJlY3Qgd2lkdGg9JzEwMDAlJyBoZWlnaHQ9JzEwMDAlJyBmaWxsPScjZmVmZWZlJyB0cmFuc2Zvcm09J3JvdGF0ZSgtMTApJy8+CgkJPHJlY3Qgd2lkdGg9JzEwMDAlJyBoZWlnaHQ9JzEwMDAlJyBmaWxsPScjYWZjY2UwJyB0cmFuc2Zvcm09J3JvdGF0ZSgtMjApJy8+CgkJPHJlY3Qgd2lkdGg9JzEwMDAlJyBoZWlnaHQ9JzEwMDAlJyBmaWxsPScjZmZmJyB0cmFuc2Zvcm09J3JvdGF0ZSgtMzApJy8+CgkJPHJlY3Qgd2lkdGg9JzEwMDAlJyBoZWlnaHQ9JzEwMDAlJyBmaWxsPScjZTRlZWY1JyB0cmFuc2Zvcm09J3JvdGF0ZSgtNDApJy8+CgkJPHJlY3Qgd2lkdGg9JzEwMDAlJyBoZWlnaHQ9JzEwMDAlJyBmaWxsPScjZmZmJyB0cmFuc2Zvcm09J3JvdGF0ZSgtNTApJy8+CgkJPHJlY3Qgd2lkdGg9JzEwMDAlJyBoZWlnaHQ9JzEwMDAlJyBmaWxsPScjYWZjY2UwJyB0cmFuc2Zvcm09J3JvdGF0ZSgtNjApJy8+CgkJPHJlY3Qgd2lkdGg9JzEwMDAlJyBoZWlnaHQ9JzEwMDAlJyBmaWxsPScjZmVmZWZlJyB0cmFuc2Zvcm09J3JvdGF0ZSgtNzApJy8+CgkJPHJlY3Qgd2lkdGg9JzEwMDAlJyBoZWlnaHQ9JzEwMDAlJyBmaWxsPScjMDg0NDZiJyB0cmFuc2Zvcm09J3JvdGF0ZSgtODApJy8+CiAgPC9zdmc+",
  "data:image/svg+xml;base64,CiAgPHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPScxMDAlJyBoZWlnaHQ9JzgnPgogICAgPGRlZnM+CiAgICAJPHBhdHRlcm4gcGF0dGVyblVuaXRzPSd1c2VyU3BhY2VPblVzZScgaWQ9J2MnIHdpZHRoPSc0JyBoZWlnaHQ9JzgnIHg9JzAnIHk9JzAnIHZpZXdCb3g9JzAgMCA1IDEwJz4KICAgIAkJPHBhdGggZmlsbC1vcGFjaXR5PScwJyBzdHJva2U9JyNhMjc1YmInIHN0cm9rZS13aWR0aD0nLjA3JyBkPSdNLTIsMUw3LDEwTS0yLDZMNywxNU0tMiwtNEw3LDUnLz4KICAgIAk8L3BhdHRlcm4+CiAgICAJPHBhdHRlcm4gcGF0dGVyblVuaXRzPSd1c2VyU3BhY2VPblVzZScgaWQ9J2MyJyB3aWR0aD0nNCcgaGVpZ2h0PSc4JyB4PScxMDAlJyB5PScwJyB2aWV3Qm94PScwIDAgNSAxMCc+CiAgICAJCTxwYXRoIGZpbGwtb3BhY2l0eT0nMCcgc3Ryb2tlPScjYTI3NWJiJyBzdHJva2Utd2lkdGg9Jy4wNycgZD0nTTcsMUwtMiwxME03LDZMLTIsMTVNNywtNEwtMiw1Jy8+CiAgICAJPC9wYXR0ZXJuPgogICAgPC9kZWZzPgogICAgPHJlY3Qgd2lkdGg9JzUwJScgaGVpZ2h0PScxMDAlJyBmaWxsPSd1cmwoI2MpJy8+CiAgICA8cmVjdCB4PSc1MCUnIHdpZHRoPSc1MCUnIGhlaWdodD0nMTAwJScgZmlsbD0ndXJsKCNjMiknLz4KICA8L3N2Zz4KICA="
];
var repeatLight = [
  "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPSc0JyBoZWlnaHQ9JzgnIHZpZXdCb3g9JzAgMCA1IDEwJz4KCTxwYXRoIGQ9J00wLDBsNSw1bC01LDVtLTEsLTZsMSwxbC0xLDFNNCwtMWw2LDZsLTYsNicgZmlsbC1vcGFjaXR5PScwJyBzdHJva2U9JyNjZWM3YzcnIHN0cm9rZS13aWR0aD0nMicvPgo8L3N2Zz4=",
  "../../old/src/img/background/light/congruent_pentagon.png",
  "../../old/src/img/background/light/congruent_pentagon.png",
  "../../old/src/img/background/light/diagonal_waves.png",
  "../../old/src/img/background/light/halftone.png",
  "../../old/src/img/background/light/skelatal_weave.png",
  "../../old/src/img/background/light/small_steps.png",
  "../../old/src/img/background/light/subtle_white_feathers.png",
  "../../old/src/img/background/light/swirl_pattern.png",
  "../../old/src/img/background/light/tree_bark.png",
  "../../old/src/img/background/light/wavegrid.png",
  "../../old/src/img/background/light/wov.png"
];
var darkImages = [
  "data:image/svg+xml;base64,CiAgPHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPScxMDAlJyBoZWlnaHQ9JzEwMCUnPgogIAk8cmVjdCB3aWR0aD0nMTAwJScgaGVpZ2h0PScxMDAlJyBmaWxsPScjZmZmJy8+CiAgICA8cmVjdCB3aWR0aD0nNTAwMCUnIGhlaWdodD0nMjAwMCUnIGZpbGwtb3BhY2l0eT0nMC4xNScgZmlsbD0nIzAwMCcgdHJhbnNmb3JtPSdyb3RhdGUoMCknLz4KICAgIDxyZWN0IHdpZHRoPSc1MDAwJScgaGVpZ2h0PScyMDAwJScgZmlsbC1vcGFjaXR5PScwLjE1JyBmaWxsPScjMDAwJyB0cmFuc2Zvcm09J3JvdGF0ZSg0LjUpJy8+CiAgICA8cmVjdCB3aWR0aD0nNTAwMCUnIGhlaWdodD0nMjAwMCUnIGZpbGwtb3BhY2l0eT0nMC4xNScgZmlsbD0nIzAwMCcgdHJhbnNmb3JtPSdyb3RhdGUoOSknLz4KICAgIDxyZWN0IHdpZHRoPSc1MDAwJScgaGVpZ2h0PScyMDAwJScgZmlsbC1vcGFjaXR5PScwLjE1JyBmaWxsPScjMDAwJyB0cmFuc2Zvcm09J3JvdGF0ZSgxMy41KScvPgogICAgPHJlY3Qgd2lkdGg9JzUwMDAlJyBoZWlnaHQ9JzIwMDAlJyBmaWxsLW9wYWNpdHk9JzAuMTUnIGZpbGw9JyMwMDAnIHRyYW5zZm9ybT0ncm90YXRlKDE4KScvPgogICAgPHJlY3Qgd2lkdGg9JzUwMDAlJyBoZWlnaHQ9JzIwMDAlJyBmaWxsLW9wYWNpdHk9JzAuMTUnIGZpbGw9JyMwMDAnIHRyYW5zZm9ybT0ncm90YXRlKDIyLjUpJy8+CiAgICA8cmVjdCB3aWR0aD0nNTAwMCUnIGhlaWdodD0nMjAwMCUnIGZpbGwtb3BhY2l0eT0nMC4xNScgZmlsbD0nIzAwMCcgdHJhbnNmb3JtPSdyb3RhdGUoMjcpJy8+CiAgICA8cmVjdCB3aWR0aD0nNTAwMCUnIGhlaWdodD0nMjAwMCUnIGZpbGwtb3BhY2l0eT0nMC4xNScgZmlsbD0nIzAwMCcgdHJhbnNmb3JtPSdyb3RhdGUoMzEuNSknLz4KICAgIDxyZWN0IHdpZHRoPSc1MDAwJScgaGVpZ2h0PScyMDAwJScgZmlsbC1vcGFjaXR5PScwLjE1JyBmaWxsPScjMDAwJyB0cmFuc2Zvcm09J3JvdGF0ZSgzNiknLz4KICAgIDxyZWN0IHdpZHRoPSc1MDAwJScgaGVpZ2h0PScyMDAwJScgZmlsbC1vcGFjaXR5PScwLjE1JyBmaWxsPScjMDAwJyB0cmFuc2Zvcm09J3JvdGF0ZSg0MC41KScvPgogICAgPHJlY3Qgd2lkdGg9JzUwMDAlJyBoZWlnaHQ9JzIwMDAlJyBmaWxsLW9wYWNpdHk9JzAuMTUnIGZpbGw9JyMwMDAnIHRyYW5zZm9ybT0ncm90YXRlKDQ1KScvPgogICAgPHJlY3Qgd2lkdGg9JzUwMDAlJyBoZWlnaHQ9JzIwMDAlJyBmaWxsLW9wYWNpdHk9JzAuMTUnIGZpbGw9JyMwMDAnIHRyYW5zZm9ybT0ncm90YXRlKDQ5LjUpJy8+CiAgICA8cmVjdCB3aWR0aD0nNTAwMCUnIGhlaWdodD0nMjAwMCUnIGZpbGwtb3BhY2l0eT0nMC4xNScgZmlsbD0nIzAwMCcgdHJhbnNmb3JtPSdyb3RhdGUoNTQpJy8+CiAgICA8cmVjdCB3aWR0aD0nNTAwMCUnIGhlaWdodD0nMjAwMCUnIGZpbGwtb3BhY2l0eT0nMC4xNScgZmlsbD0nIzAwMCcgdHJhbnNmb3JtPSdyb3RhdGUoNTguNSknLz4KICAgIDxyZWN0IHdpZHRoPSc1MDAwJScgaGVpZ2h0PScyMDAwJScgZmlsbC1vcGFjaXR5PScwLjE1JyBmaWxsPScjMDAwJyB0cmFuc2Zvcm09J3JvdGF0ZSg2MyknLz4KICAgIDxyZWN0IHdpZHRoPSc1MDAwJScgaGVpZ2h0PScyMDAwJScgZmlsbC1vcGFjaXR5PScwLjE1JyBmaWxsPScjMDAwJyB0cmFuc2Zvcm09J3JvdGF0ZSg2Ny41KScvPgogICAgPHJlY3Qgd2lkdGg9JzUwMDAlJyBoZWlnaHQ9JzIwMDAlJyBmaWxsLW9wYWNpdHk9JzAuMTUnIGZpbGw9JyMwMDAnIHRyYW5zZm9ybT0ncm90YXRlKDcyKScvPgogICAgPHJlY3Qgd2lkdGg9JzUwMDAlJyBoZWlnaHQ9JzIwMDAlJyBmaWxsLW9wYWNpdHk9JzAuMTUnIGZpbGw9JyMwMDAnIHRyYW5zZm9ybT0ncm90YXRlKDc2LjUpJy8+CiAgICA8cmVjdCB3aWR0aD0nNTAwMCUnIGhlaWdodD0nMjAwMCUnIGZpbGwtb3BhY2l0eT0nMC4xNScgZmlsbD0nIzAwMCcgdHJhbnNmb3JtPSdyb3RhdGUoODEpJy8+CiAgICA8cmVjdCB3aWR0aD0nNTAwMCUnIGhlaWdodD0nMjAwMCUnIGZpbGwtb3BhY2l0eT0nMC4xNScgZmlsbD0nIzAwMCcgdHJhbnNmb3JtPSdyb3RhdGUoODUuNSknLz4KICA8L3N2Zz4=",
  "data:image/svg+xml;base64,CiAgPHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPScxMDAlJyBoZWlnaHQ9JzEwMCUnPgogICAgPHJlY3Qgd2lkdGg9JzEwMDAlJyBoZWlnaHQ9JzEwMDAlJyBmaWxsPScjZmZmJy8+CiAgICA8cmVjdCB3aWR0aD0nMTAwJScgaGVpZ2h0PScxMDAlJyBmaWxsPScjODA0MTA3Jy8+CiAgICA8c3ZnIHg9JzUwJScgeT0nNTAlJyBvdmVyZmxvdz0ndmlzaWJsZSc+CiAgICAgIDxyZWN0IHdpZHRoPScyMDAwJScgaGVpZ2h0PScyMDAwJScgZmlsbC1vcGFjaXR5PScwLjEnIGZpbGw9JyMwMDAnIHRyYW5zZm9ybT0ncm90YXRlKDIwKScvPgogICAgICA8cmVjdCB3aWR0aD0nMjAwMCUnIGhlaWdodD0nMjAwMCUnIGZpbGwtb3BhY2l0eT0nMC4xJyBmaWxsPScjMDAwJyB0cmFuc2Zvcm09J3JvdGF0ZSg0MCknLz4KICAgICAgPHJlY3Qgd2lkdGg9JzIwMDAlJyBoZWlnaHQ9JzIwMDAlJyBmaWxsLW9wYWNpdHk9JzAuMScgZmlsbD0nIzAwMCcgdHJhbnNmb3JtPSdyb3RhdGUoNjApJy8+CiAgICAgIDxyZWN0IHdpZHRoPScyMDAwJScgaGVpZ2h0PScyMDAwJScgZmlsbC1vcGFjaXR5PScwLjEnIGZpbGw9JyMwMDAnIHRyYW5zZm9ybT0ncm90YXRlKDgwKScvPgogICAgICA8cmVjdCB3aWR0aD0nMjAwMCUnIGhlaWdodD0nMjAwMCUnIGZpbGwtb3BhY2l0eT0nMC4xJyBmaWxsPScjMDAwJyB0cmFuc2Zvcm09J3JvdGF0ZSgxMDApJy8+CiAgICAgIDxyZWN0IHdpZHRoPScyMDAwJScgaGVpZ2h0PScyMDAwJScgZmlsbC1vcGFjaXR5PScwLjEnIGZpbGw9JyMwMDAnIHRyYW5zZm9ybT0ncm90YXRlKDEyMCknLz4KICAgICAgPHJlY3Qgd2lkdGg9JzIwMDAlJyBoZWlnaHQ9JzIwMDAlJyBmaWxsLW9wYWNpdHk9JzAuMScgZmlsbD0nIzAwMCcgdHJhbnNmb3JtPSdyb3RhdGUoMTQwKScvPgogICAgICA8cmVjdCB3aWR0aD0nMjAwMCUnIGhlaWdodD0nMjAwMCUnIGZpbGwtb3BhY2l0eT0nMC4xJyBmaWxsPScjMDAwJyB0cmFuc2Zvcm09J3JvdGF0ZSgxNjApJy8+CiAgICAgIDxyZWN0IHdpZHRoPScyMDAwJScgaGVpZ2h0PScyMDAwJScgZmlsbC1vcGFjaXR5PScwLjEnIGZpbGw9JyMwMDAnIHRyYW5zZm9ybT0ncm90YXRlKDE4MCknLz4KICAgICAgPHJlY3Qgd2lkdGg9JzIwMDAlJyBoZWlnaHQ9JzIwMDAlJyBmaWxsLW9wYWNpdHk9JzAuMScgZmlsbD0nIzAwMCcgdHJhbnNmb3JtPSdyb3RhdGUoMjAwKScvPgogICAgICA8cmVjdCB3aWR0aD0nMjAwMCUnIGhlaWdodD0nMjAwMCUnIGZpbGwtb3BhY2l0eT0nMC4xJyBmaWxsPScjMDAwJyB0cmFuc2Zvcm09J3JvdGF0ZSgyMjApJy8+CiAgICAgIDxyZWN0IHdpZHRoPScyMDAwJScgaGVpZ2h0PScyMDAwJScgZmlsbC1vcGFjaXR5PScwLjEnIGZpbGw9JyMwMDAnIHRyYW5zZm9ybT0ncm90YXRlKDI0MCknLz4KICAgICAgPHJlY3Qgd2lkdGg9JzIwMDAlJyBoZWlnaHQ9JzIwMDAlJyBmaWxsLW9wYWNpdHk9JzAuMScgZmlsbD0nIzAwMCcgdHJhbnNmb3JtPSdyb3RhdGUoMjYwKScvPgogICAgICA8cmVjdCB3aWR0aD0nMjAwMCUnIGhlaWdodD0nMjAwMCUnIGZpbGwtb3BhY2l0eT0nMC4xJyBmaWxsPScjMDAwJyB0cmFuc2Zvcm09J3JvdGF0ZSgyODApJy8+CiAgICAgIDxyZWN0IHdpZHRoPScyMDAwJScgaGVpZ2h0PScyMDAwJScgZmlsbC1vcGFjaXR5PScwLjEnIGZpbGw9JyMwMDAnIHRyYW5zZm9ybT0ncm90YXRlKDMwMCknLz4KICAgICAgPHJlY3Qgd2lkdGg9JzIwMDAlJyBoZWlnaHQ9JzIwMDAlJyBmaWxsLW9wYWNpdHk9JzAuMScgZmlsbD0nIzAwMCcgdHJhbnNmb3JtPSdyb3RhdGUoMzIwKScvPgogICAgICA8cmVjdCB3aWR0aD0nMjAwMCUnIGhlaWdodD0nMjAwMCUnIGZpbGwtb3BhY2l0eT0nMC4xJyBmaWxsPScjMDAwJyB0cmFuc2Zvcm09J3JvdGF0ZSgzNDApJy8+CiAgICAgIDxyZWN0IHdpZHRoPScyMDAwJScgaGVpZ2h0PScyMDAwJScgZmlsbC1vcGFjaXR5PScwLjEnIGZpbGw9JyMwMDAnIHRyYW5zZm9ybT0ncm90YXRlKDM2MCknLz4KCiAgICA8L3N2Zz4KICA8L3N2Zz4="
];
var repeatDark = [
  "../../old/src/img/background/dark/congruent_outline.png",
  "../../old/src/img/background/dark/footer_lodyas.png"
];

var fonts = ["Lato", "Dawn", "Pacifico", "Poirot", "Yanone", "Bree", "Righteous", "Satisfy", "Roboto"];

//bruh use these amazing gradients as background from here: https://descartes.io/?utm_source=SitePoint&utm_medium=email&utm_campaign=Versioning

var defaultMaxWidthBeforeLineBreak = 850;
// 91 'd's covered 602px
var charactersPerLine = 91;
var characterPerPixel = charactersPerLine/602;

var textAreaSingleLineCharacterLength = characterPerPixel * 1;

var images = {
  "LIGHT": lightImages,
  "DARK": darkImages,
  "REPEAT_LIGHT": repeatLight,
  "REPEAT_DARK": repeatDark
};

var characterReplaceMap = {
  "|": "-"
};

var quotes = [
  "There are a lot of ways to neutralise your enemy. Forgiving him is the first of all.",
  "If you run away from it, grief will chase you. Stand your ground, it will run away from you.",
  "If you always put limits on everything you do, physical or anything else,. it will spread into your work and into your life. There are no limits. There are only plateaus,. and you must not stay there, you must go beyond them. |Bruce Lee",
  "Unless you try to do something beyond. what you have already mastered you will never grow",
  "Your time is limited, so don't waste it living someone else's life. Don't be trapped by dogma: which is living with the results of other people's thinking. Don't let the noise of others' opinions drown out your own inner voice. And most important, have the courage to follow your heart and intuition. They somehow already know what you truly want to become. Everything else is secondary.",
  "Roads in the mountains teach you a very important lesson in life. what seems like an END is very often just a BEND.",
  "I hated every minute of training, but I said, Don't Quit. Suffer now and live the rest of your life as champion.",
  "Have you ever seen books or courses titled. 'Learn Aeronautical Engineering in 21 Days' or 'Bridge Construction for Idiots'?. Of course not, yet good developers will spend just as long learning their craft. The primary difference is that development has a lower barrier to entry, and you're less likely to hurt anyone with shoddy code. â€¦ unless your software is used to design aircraft or bridges!. -        Coding is difficult        - . You'll be able to create a few simple programs within days,. but you'll need many months' knowledge to confidently tackle a large application. Most professional jobs require several years of solid experience. Even then, you're always learning.",
  "We all die, The goal isn't to live forever. the goal is to create something that will.",
  "We are drowning in information while starving for wisdom.",
  "Relationships never die a natural death they are always murdered by ego, attitude and ignorance.",
  "The courage to share your gift with others, is what separates the artist from amateurs"
];

var quotesStringSeparator = "]][[";

var newQuoteIndex = 1;
var quotesObj = [];

export function walls() {
  "use strict";
import $ from "jquery";
  window.jQuery = $; //rivets below can't find jQuery variable from jQuery, so I had to do this.
import _ from "underscore";
import '../../external/html2canvas/build/html2canvas.min';
import rivets from "rivets";
import '../util/rivets.custom';

  rivets.formatters.invert = function(value){
    return !value;
  };

  var self = this;
  self.$$ = $("<div module='walls'></div>");
  $("body .content")
    .unbind().off()
    .html(self.$$);

  if(localStorage.getItem("quotes") !== null){
    quotes = localStorage.getItem("quotes").split(quotesStringSeparator);
  }
  if(localStorage.getItem("quoteObj") !== null){
    var prevQuoteObj = JSON.parse(localStorage.getItem("quoteObj"));
    quotesObj = prevQuoteObj;
  } else {
    quotesObj = getQuotesObj(quotes);
  }
  updateLocalStorageQuotes();

  fetch('old/src/modules/walls/walls.html')
    .then(template => template.text())
    .then(templateString =>
      self.$$
        .html(_.template(templateString)({})))
    .then(function () {
      rivets.bind(self.$$, {
        model: {
          quotes: quotesObj,
          actions: {
            editModeOff: turnEditModeOff(),
            focusTextArea: focusTextArea()
          },
          walls: {
            all: images.REPEAT_LIGHT.concat(images.REPEAT_DARK).map(function(image, index){
              return index;
            })
          },
          fonts: fonts
        }
      });

      generateWallpapers();
      self.$$.find("#generate-wallpapers").on("click", generateWallpapers);
      self.$$.find(".newQuote").on("keypress", addNewQuote);
      self.$$.find("quote").on("mousedown", removeQuote);

    });


}

function generateWallpapers(){
  $('wallpaper[quoteid]').each(function(){
    var $this = $(this);
    var styles = {};
    $this.html("");
    var quoteid = $this.attr("quoteid");
    var selector = "wallpaper[quoteid='"+ quoteid +"']";
    appendWallPaperTemplate(quoteid, selector).done(function(){
      quotesObj.map((quoteObj, index) => {
        if(quoteObj.id === quoteid){
          styles = quoteObj.styles ? quoteObj.styles : {};
          generateWallPaper(quotesObj[index].text, styles, "#wallpaper"+quoteid);
          return false;
        }
      });
     wallpaperify(quoteid);
    });
  });
  $(".chooseBackground")
    .unbind()
    .on("change", changeBackground);
  $(".chooseFont")
    .unbind()
    .on("change", changeFont);
  $(".chooseFontColor")
    .unbind()
    .on("change", changeFontColor);
}

function updateLocalStorageQuotes(){
  var updatedQuotesList = quotesObj.map(quoteObj => quoteObj.text);
  var updatedQuotesListString = updatedQuotesList.join(quotesStringSeparator);
  localStorage.setItem("quotes", updatedQuotesListString);
  localStorage.setItem("quoteObj", JSON.stringify(quotesObj));
  console.log("The quotesObj: ", quotesObj);
}

function getQuotesObj(quotes){
  return (quotes.map((quote, i) => ({
      id: "" + i,
      editId: "E"+i,
      text: quote,
      editMode: false,
      rows : Math.round(quote.length / charactersPerLine) + 1,
      styles: {
        background: "",
        font: "",
        fontColor: ""
      }
    })
  ));
}

function addNewQuote(e){
  if(e.which === 13){
    var quote = $(this).val();
    if(quote === ""){return false;}
    var quoteid = "N" + newQuoteIndex;
    var selector = "wallpaper[quoteid='"+ quoteid +"']";
    quotesObj.unshift({
      id: quoteid,
      editId: "NE"+newQuoteIndex,
      text: quote,
      editMode: false,
      rows : Math.round(quote.length / charactersPerLine) + 1,
      rendered : false,
      styles: {
        background: "",
        font: "",
        fontColor: ""
      }
    });
//    appendWallPaperTemplate(quoteid, selector).done(function(){
//      generateWallPaper(quote, {}, "#wallpaper"+quoteid);
//    });
    generateWallpapers();
    quotesObj[0].rendered = true;
    newQuoteIndex = newQuoteIndex + 1;
    $(this).val("");
    updateLocalStorageQuotes();
    return false;
  }
}

function removeQuote(e) {
  if(e.button === 2){
    var quoteid = $(this).attr("quoteid");
    //remove wallpaper
    quotesObj.map((quoteObj, i) => {
      if(quoteObj.id === quoteid){
        quotesObj.splice(i,1);
        updateLocalStorageQuotes();
        $("wallpaper[quoteid='"+ quoteid +"']").remove();
        generateWallpapers();
        return false;
      }
    });
    return false;
  }
}

function appendWallPaperTemplate(index, container) {
  var wallPaperTemplateString = [
      '<div class="background" id="wallpaper' + index + '">',
    '<div class="quoteBox">',
    '<div class="quoteContainer">',
    '</div></div></div>',
      '<div class="downloadBtnContainer"><a class="download gen-btn" id="download' + index + '">Download</a></div>'
  ].join("");
  $(container).append(wallPaperTemplateString);
  return $.when();
}

function downloadCanvas(link, canvasId, filename) {
  link.href = document.getElementById(canvasId).toDataURL();
  link.download = filename;
}

//make ["  asfd","asdf ","",""] => ["asfd","asdf"]
function removeEmptyElements(array) {
  for (var i = 0; i < array.length; i++) {
    array[i] = array[i].trim();
    if (array[i] === "") {
      array.splice(i, 1);
    }
  }
  if (array.indexOf("") !== -1) {
    removeEmptyElements(array);
  }
  return array;
}


function getOriginalWidth(quote) {
  var $quoteContainer = $("#dummy").find(".quoteContainer");
  $quoteContainer.html(quote);
  var width = $quoteContainer.innerWidth();
  $quoteContainer.html("");
  return width;
}

function generateWallPaper(quote, styles, selector) {
  //styles = {backgroundType, backgroundNo, backgroundZoom, fontColor, font}
  var backgroundList = styles && styles.backgroundType ? images[styles.backgroundType] : images.REPEAT_LIGHT.concat(images.REPEAT_DARK),
      backgroundNo = styles && styles.background ? styles.background : Math.round(Math.random() * (backgroundList.length - 1 )),
      background = backgroundList[backgroundNo],
      backgroundSize = styles && styles.backgroundZoom ? (styles.backgroundZoom + '%') : '100%',
      font = styles && styles.font ? styles.font : "",
      fontColor = styles && styles.fontColor ? styles.fontColor : '#ffffff',
      maxWidthBeforeLineBreak = styles && styles.maxWidthBeforeLineBreak ? styles.maxWidthBeforeLineBreak : defaultMaxWidthBeforeLineBreak,
      quoteParts = removeEmptyElements(quote.split(".")),
      quotePartOccupyWidth = getOriginalWidth(quote),
      quoteTemplate = "",
      $quoteContainer = $(selector).find(".quoteContainer");

  $(selector).css({
    background : 'url(' + background + ') repeat center center',
//    backgroundSize: backgroundSize ,
    color: fontColor
  });

  if(quotePartOccupyWidth < maxWidthBeforeLineBreak){
    quoteTemplate = '<div class="line">'+quote+'</div>';
  } else {
    quoteTemplate = quoteParts.map(function (part, i) {
      if (part.indexOf("|") !== -1) {
        part = part.replace("|", "-");
        return '<div class="quoteBy line line' + i + '">' + part + '</div><br/>';
      } else {
        return '<div class="line line' + i + '">' + part + '</div><br/>';
      }
    });
  }

  $quoteContainer.html(quoteTemplate);
  $quoteContainer.find(".line").each(function () {
    var width = $(this).innerWidth();
    var reqPercentWidth = (maxWidthBeforeLineBreak / width) * 100;
    $(this).not(".quoteBy").css("font-size", reqPercentWidth + "%");
  });

  $quoteContainer
    .removeClass()
    .addClass("quoteContainer " + font);
}

//function generateWallpapers() {
//  var self = this;
//  $("#dummy").siblings().remove(); //need dummy to be there
//  var finalQuoteList = quotesObj.map(quoteObj => quoteObj.text);
//  finalQuoteList.map(function (quote, index) {
//    appendWallPaperTemplate(index, ".walls-generated").done(function () {
//      generateWallPaper(quote, {}, "#wallpaper"+id);
//      wallpaperify(index);
//    });
//  });
//}

function wallpaperify(index){
  html2canvas($("#wallpaper" + index), {
    onrendered: function (canvas) {
      document.body.appendChild(canvas);
      $(canvas).attr("id", "canvas" + index);
      // Convert and download as image
      $("#wallpaper" + index).replaceWith(canvas);
      document.getElementById('download' + index).addEventListener('click', function () {
        downloadCanvas(this, 'canvas' + index, 'test.png');
      }, false);
    }
  });
}

function turnEditModeOff(e){
  return function(e){
    if(!e.shift && e.which === 13){
      var quoteid = $(this).attr("quoteid");
      quotesObj.map(quoteObj => {
        if(quoteObj.id === quoteid){
          quoteObj.editMode = false;
        }
      });
      generateWallpapers();
      return false; //to prevent line break in textarea
    }
  };
}

function focusTextArea(e){
  return function(e){
    //this function only seems to get fired when input is checked, not when unchecked
    $(this).siblings("textarea").focus();
  };
}

function changeBackground(){
  var newBg = $(this).val();
  var quoteid = $(this).closest(".customizeMenuContainer").attr("quoteid");
  quotesObj.map(function(quoteObj){
    if(quoteObj.id === quoteid){
      quoteObj.styles.background = newBg;
    }
  });
  updateLocalStorageQuotes();
  generateWallpapers();
}

function changeFont(){
  var newFont = $(this).val();
  var quoteid = $(this).closest(".customizeMenuContainer").attr("quoteid");
  quotesObj.map(function(quoteObj){
    if(quoteObj.id === quoteid){
      quoteObj.styles.font = newFont;
    }
  });
  updateLocalStorageQuotes();
  generateWallpapers();
}


function changeFontColor(){
  var newFontColor = $(this).val();
  var quoteid = $(this).closest(".customizeMenuContainer").attr("quoteid");
  quotesObj.map(function(quoteObj){
    if(quoteObj.id === quoteid){
      quoteObj.styles.fontColor = newFontColor;
    }
  });
  updateLocalStorageQuotes();
  generateWallpapers();
}